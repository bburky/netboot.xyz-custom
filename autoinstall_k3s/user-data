#cloud-config
autoinstall:
    version: 1
    # early-commands:
    #     - foo
    # network:
    #     network:
    # packages:
    #     - foo
    storage:
        swap:
           size: 0
        layout:
            name: lvm
            match:
                model: "APPLE_SSD_SM128E"
                # APPLE_SSD_SM128E
                # WDC_WD80EMAZ-00WJTA0
    ssh:
        install-server: yes
        authorized-keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDOqA17LOoERyTpng12R8JunvdqPZpAVlBWKPRGklvGcyMyzjr+bw8SZk+NLMmgFATkg2WbH58Rrf59UC6cUuvse45rn0BBADhNY2Hq1ZT2+NHGXOF0BjHLboJN+63ogndnc8UwOPxr55yHFOe7a5c5I9yO09Fw7sjUL5p9btLnigspmd3Mz5xIlRhdrnEfloiVJ2kl0p+2GC6Z1vxQ/rm+qIg1imb+hI2DEJ/yAi0+5x0+Bu8zJ77A7SlplvLvOE4rOB4LnIIppMIpKw+4mPAOg+rORVaUsD17bqSoR4PQJlH9+TcoaEM9hAMWegzyYqXxQsr8lF2zOT7odaZmZmlpzIoYlPfiO0bJBY28LLAzXu2Xl3cwhpaLDOt6Fjx5hdAaylUp0yfkIXEbEm2pC+OYdNWi1AKt4wr3EesdqkovhnA35DbPe4e79qKiuzcJXA1O2QcIvgDFM+njvcGjIKA0JOo/7itMHkjXTQ6h/3ko+dkMQa//35PMF85zZH5P08U=
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAlMvKelq4naw8MBhzQ7O6JlBeBxjvpOoLoQsPRCEdfI
        allow-pw: no
    late-commands:
        - echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ubuntu
        - sleep 9999
    user-data:
        hostname: server-k3s
        packages:
            - jq
            - beep
        # ssh_pwauth: True
        # disable_root: false
        # preserve_hostname: true
        write_files:
        -   path: /etc/sysctl.d/99-k8s.conf
            permissions: '0644'
            content: |
                vm.max_map_count=1524288
                fs.inotify.max_user_instances=8192
        -   path: /etc/security/limits.d/99-k8s.conf
            permissions: '0644'
            content: |
                * hard nofile 1000000
                * soft nofile 1000000
                * hard nproc 8192
                * soft nproc 8192
        runcmd:
        - swapoff -a
        - sed -e '/swap/ s/^#*/#/' -i /etc/fstab
        - systemctl mask swap.target
        - sysctl --system

        # Beep on completion of cloud-init
        - 'modprobe pcspkr'
        - 'beep -d 1200 -f 988 -l 200 --new -f 1319 -l 800'

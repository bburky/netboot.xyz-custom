#cloud-config
autoinstall:
    version: 1
    early-commands:
        - |
            [ "$(cat /sys/devices/virtual/dmi/id/board_name)" = "X11SSV-Q" ] || (echo "ERROR: board_name mismatch" && exit 1)
    # network:
    #     network:
    # packages:
    #     - foo
    storage:
        swap:
          size: 0
        # layout:
        #     name: lvm
        #     match:
        #         model: "APPLE_SSD_SM128E"
        #         # APPLE_SSD_SM128E
        #         # WDC_WD80EMAZ-00WJTA0
        config:
            # based on from the insaller's autogenerated default lvm install
            - id: disk-sda
              ptable: gpt
              path: /dev/sda
              wipe: superblock-recursive
              preserve: false
              name: ''
              grub_device: false
              type: disk
            - id: partition-0
              device: disk-sda
              size: 512M
              wipe: superblock
              flag: boot
              number: 1
              preserve: false
              grub_device: true
              type: partition
            - id: format-0
              label: efi
              fstype: fat32
              volume: partition-0
              preserve: false
              type: format
            - id: partition-1
              device: disk-sda
              size: 2G
              wipe: superblock
              number: 2
              preserve: false
              type: partition
            - id: format-1
              fstype: ext4
              volume: partition-1
              preserve: false
              type: format
            - id: partition-2
              device: disk-sda
              wipe: superblock
              number: 3
              preserve: false
              type: partition
              size: -1
            - id: lvm_volgroup-0
              name: ubuntu-vg
              devices:
              - partition-2
              preserve: false
              type: lvm_volgroup
            - id: lvm_partition-0
              name: ubuntu-lv
              volgroup: lvm_volgroup-0
              wipe: superblock
              preserve: false
              type: lvm_partition
            - id: format-2
              fstype: ext4
              volume: lvm_partition-0
              preserve: false
              type: format
            - id: mount-2
              path: /
              device: format-2
              type: mount
            - id: mount-1
              path: /boot
              device: format-1
              type: mount
            - id: mount-0
              path: /boot/efi
              device: format-0
              type: mount

            # based on https://github.com/ubuntu/zsys-install/blob/master/curtin-zfs-efi.yaml
            - id: disk2
              type: disk
              ptable: gpt
              path: /dev/sdb
              wipe: superblock-recursive
            # we're using GPT and EFI, creating ESP partition
            - id: disk2p0
              device: disk2
              flag: boot
              number: 1
              offset: 1M
              size: 512M
              type: partition
              wipe: superblock
            - id: disk2p0_format
              label: efi
              fstype: fat32
              type: format
              volume: disk2p0
            # partition for filesystem
            - id: disk2p1
              type: partition
              number: 2
              size: -1
              device: disk2
            # make a zpool with our disk
            # zpool create -o ashift=12 \
            #              -O atime=off -O canmount=off -O compression=lz4 \
            #              -O normalization=formD -O mountpoint=/ -R /TARGET_MOUNTPOINT \
            #              tank /dev/disk/by-id/virtio-abcdefghi123
            - type: zpool
              id: disk2_tank
              pool: tank
              vdevs:
              - disk2p1
              mountpoint: /
              pool_properties:
                ashift: 12      # (or more, based on /sys)
              fs_properties:
                acltype: posixacl
                relatime: on
                canmount: off
                compression: lz4
                devices: off
                #normalization: formD  # Disabled for the time being until boot is stable
                xattr: sa
            # Create ROOT datasets
            # zfs create tank/ROOT -o canmount=off -o mountpoint=none
            - type: zfs
              id: disk2_tank
              pool: disk2_tank
              volume: /ROOT   # (tank/ROOT)
              properties:
                canmount: off
                mountpoint: none
            # WORKAROUND: create the ESP mount AFTER / on ZFS
            # -   id: disk2p0_mount
            #     device: disk2p0_format
            #     path: /boot/efi
            #     type: mount
    ssh:
        install-server: yes
        authorized-keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDOqA17LOoERyTpng12R8JunvdqPZpAVlBWKPRGklvGcyMyzjr+bw8SZk+NLMmgFATkg2WbH58Rrf59UC6cUuvse45rn0BBADhNY2Hq1ZT2+NHGXOF0BjHLboJN+63ogndnc8UwOPxr55yHFOe7a5c5I9yO09Fw7sjUL5p9btLnigspmd3Mz5xIlRhdrnEfloiVJ2kl0p+2GC6Z1vxQ/rm+qIg1imb+hI2DEJ/yAi0+5x0+Bu8zJ77A7SlplvLvOE4rOB4LnIIppMIpKw+4mPAOg+rORVaUsD17bqSoR4PQJlH9+TcoaEM9hAMWegzyYqXxQsr8lF2zOT7odaZmZmlpzIoYlPfiO0bJBY28LLAzXu2Xl3cwhpaLDOt6Fjx5hdAaylUp0yfkIXEbEm2pC+OYdNWi1AKt4wr3EesdqkovhnA35DbPe4e79qKiuzcJXA1O2QcIvgDFM+njvcGjIKA0JOo/7itMHkjXTQ6h/3ko+dkMQa//35PMF85zZH5P08U=
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAlMvKelq4naw8MBhzQ7O6JlBeBxjvpOoLoQsPRCEdfI
        allow-pw: no
    late-commands:
        - echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ubuntu
    user-data:
        hostname: server-k3s
        packages:
            - jq
            - beep
        # ssh_pwauth: True
        # disable_root: false
        # preserve_hostname: true
        write_files:
        -   path: /etc/sysctl.d/99-k8s.conf
            permissions: '0644'
            content: |
                vm.max_map_count=1524288
                fs.inotify.max_user_instances=8192
        -   path: /etc/security/limits.d/99-k8s.conf
            permissions: '0644'
            content: |
                * hard nofile 1000000
                * soft nofile 1000000
                * hard nproc 8192
                * soft nproc 8192
        runcmd:
        - swapoff -a
        - sed -e '/swap/ s/^#*/#/' -i /etc/fstab
        - systemctl mask swap.target
        - sysctl --system

        - |
            curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL="v1.26" INSTALL_K3S_EXEC="--disable=traefik" K3S_KUBECONFIG_MODE="644" sh -s - 

        - 'mkdir /home/ubuntu/.kube'
        # TODO: may have issues with multiple interfaces
        - |
            sed "s_server: .*_server: https://$(ip --json route get 192.168.0.1  | jq -r '.[0].prefsrc'):6443/_" /etc/rancher/k3s/k3s.yaml > /home/ubuntu/.kube/config
        - chown -R ubuntu:ubuntu /home/ubuntu/.kube

        # Beep on completion of cloud-init
        - 'modprobe pcspkr'
        - 'beep -d 1200 -f 988 -l 200 --new -f 1319 -l 800'
